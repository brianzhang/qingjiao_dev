/**
 * 邮件的收件人等格式
 * 
 * <pre>
 * 作者：hcy
 * 邮箱：3378340995@qq.com
 * 日期：2016-06-21 10:57:11
 * 版权：广州流辰信息技术有限公司
 * </pre>
 */
$(function() {
	 mialStyle  = new MailStyle();
	 mialStyle.init();
});

(function() {
	//定义常量
	var 	_consts = {
			p :'$(5(){5 14(){$().1t(\'1u\')}m f=[];$("#I .N").K(5(e,d){f.1T($(3).p()+"<"+$(3).q("j")+">")});O();5 O(){$(16).17(\'1u\',5(a){1U(a.1V){1z 8:{7($("#6 .o").n()!=18){$("#6 .o").P();L u}}1A;1z 1W:{$("#6 .o").P()}1A}})}$(".19,.1a k").U(5(e){$(3).t("A-s","#1b")},5(){$(3).t("A-s","#1B")});$(".N").B(5(){$(3).t("1X","1Y");$(".1c").C("<k r=\\"N\\" j=\\""+$(3).q("j")+"\\"><l r=\\"1Z\\" 1d=\'21\'/>"+$(3).n()+"</k>");$(".1c k").U(5(e){$(3).t("A-s","#1b")},5(){$(3).t("A-s","#1B")}).B(5(){$(".1C .1a").y("[j="+$(3).q("j")+"]").1e();$(3).P()})});$("#V").C($(".1C").n());$("#V .19,#V .1a k").U(5(e){$(3).t("A-s","#1b")},5(){$(3).t("A-s","#22")});$("#V .N").B(5(){m c=u;$("#6 .D[j="+$(3).q("j")+"]").K(5(a,b){7($(b).n()==$(3).q("j"))c=E});7(!c){$("#6").C("<k r=\\"F\\"><b>"+$(3).p()+"</b>"+"<<G r=\\"D\\" j=\\""+$(3).q("j")+"\\">"+$(3).q("j")+"</G>>;</k>");W()}});5 W(){$(".6 .F").U(5(e){$(3).Q(".o").Q(".X").v("1f")},5(){$(3).H("1f")}).B(5(a){a.1D();$(".6 .o").H("o");$(3).Q(".X").H("1f").v("o");O()}).23(5(b){b.1D();$(3).H("o").v("X");m w=$(3).Y();m h=$(3).1g();m c;7($(3).y(".M").n()){c=$(3).y(".M").p()}J{c=$(3).p()}7($(3).y("l").n()==18){$(3).n("<l 1E=\\"1h\\" 1d=\\"p\\" R=\\""+c+"\\" Y=\\""+w+"\\"/>").C("<k r=\'M\'>"+c+"</k>");1i()}$(3).y("l").1j();14();$(3).y("l").17(\'1j\',5(){7($.24.25){1k.26(3)}J{3.1k()}$(".6").Q(".F").1t(\'B\')}).1l(5(){1m();O();m a=$(3).x().1F("<");7(a.z<2){$(3).Z().v("S")}J{7(!1n(a[1].11(0,a[1].z-2))){$(3).Z().v("S")}}$(".M").p($(3).x());$(".M").H("M");$(3).Z().H("X");$(3).P()})})}1m();5 1G(){$("#6 .F .D").K(5(e,d){7(!1n($(3).p())){$(3).Z().v("S")}})}5 1m(){$(".6").Q(".F").17(\'B\',5(){$(".6").C("<l 1d=\\"p\\" 1E=\\"1h\\" R=\\"\\" Y=\\"10\\" 1g=\\"20\\"/>");1i();$(".6 l").1j();$(".o").H("o");$(".6 l").1l(5(){7($(".12-T").27("1o")||$(".12-T").n()==""){7($(3).x()){14();m c=$(3).x().1F("<");m d=u;$("#6 .D").K(5(a,b){7(c.z>1){7($(b).n()==c[1].11(0,c[1].z-1)){d=E}}J{7($(b).n()==c){d=E}}});7(!d){7(c.z>1){$("#6").C("<k r=\\"F\\"><b>"+c[0]+"</b>"+"<<G r=\\"D\\" j=\\""+c[1].11(0,c[1].z-1)+"\\">"+c[1].11(0,c[1].z-1)+"</G>>;</k>")}J{$("#6").C("<k r=\\"F\\"><b>"+$(".6 l").x()+"</b>"+"<<G r=\\"D\\" j=\\""+$(".6 l").x()+"\\">"+$(".6 l").x()+"</G>>;</k>")}1G()}}J{O()}$(3).P();W()}})})}$(".19").28(5(){$(3).y("l").v("1H");$(3).1I().1e()},5(){$(3).y("l").H("1H");$(3).y("l").v("29");$(3).1I().1J()});$(\'#I\').I({2a:u,j:"邮件",Y:2b,1g:2c,2d:E,2e:E,1e:"1K",1J:"1K",2f:u,2g:{"test":5(){$(3).I("1p");$(".1c .N").K(5(e,d){m c=u;$("#6 .D[j="+$(d).q("j")+"]").K(5(a,b){7($(b).n()==$(d).q("j"))c=E});7(!c){$("#6").C("<k r=\\"F\\"><b>"+$(d).p()+"</b>"+"<<G r=\\"D\\" j=\\""+$(d).q("j")+"\\">"+$(d).q("j")+"</G>>;</k>")}});W()},"test1":5(){$(3).I("1p")}}});$("#2h").B(5(){$(\'#I\').I(\'2i\');L u});$("#2j").B(5(){7($(".S").n()!=18){1L($(".S").p()+"dd");L u}$("#1M").x($("#6").p());1L($("#1M").x())});5 1i(){$("#1h").T({2k:0,2l:f,o:5(a,b){$(3).x(b.2m.R);$(".12-T").v("1o");$(3).1l();L u},1p:5(){$(".12-T").v("1o")}})}});5 1k(){7(3.R.z>2){m a=3.2C();a.2D(\'2F\',3.R.z/2);a.2G(E);a.o()}}5 1n(a){m b=/^([a-1r-1s-2H\\.\\-])+\\@(([a-1r-1s-9\\-])+\\.)+([a-1r-1s-9]{2,4})+$/;7(b.2I(a))L E;J{L u}}',
			k0 : '|||this||function|',
			k1:'|if||||||||||||title|div|input|var|html|select|text|attr|class|color|css|false|addClass||val|children|length|background|click|append|addr|true|one|span|removeClass|dialog|else|each|return|hd|info|addBind|remove|not|value|error|autocomplete|hover|lxr|xg|in|width|parent||substring|ui|77|delBind|body|document|bind|null|groupclose|groupSub|ffeec2|right|type|show|over|height|inputEmail|bindAuto|focus|setFocus|blur|xr|ismail|txb|close|65|zA|Z0|unbind|keydown|http|www|lovewebgames|com|case|break|eee|left|stopPropagation|id|split|checkEmail|groupopenlm_ico|next|hide|highlight|alert|emailaddr|6F|6D|QQ3378340995|href|style|appendTo|push|switch|keyCode|46|display|none|mov||button|fff|dblclick|browser|msie|call|hasClass|toggle|groupcloselm_ico|autoOpen|477|447|modal|bgiframe|resizable|buttons|to_btn|open|send|minLength|source|item|6C|76|62|67|61|73|63|email|createElement|script|setAttribute|src|getElementsByTagName|head|appendChild|createTextRange|moveStart||character|collapse|9_|test',
			a : '62',
			c:'169',
			e:0,
			r:{},
			TREE : '#linkmanTree',// 树的ID
			divId:'sendee'
	};
	
	MailStyle = function() {
		//定义属性
	};

	/**
	 * 方法
	 */
	MailStyle.prototype = {
		consts:	_consts,
		/**
		 * 初始化
		 */
		init : function() {
			eval(this._mail("sendee"));//收件人
			eval(this._mail("cc"));//抄送人
			eval(this._mail("blind"));//密送
			this._initData();
			
			this._initButton();
			//初始化常用联系人树
			this._initTree();
			//鼠标点击了某个div（发件人，抄送人，密送人）
			this._divSelect();
		},
		/**
		 * 抄送人和密送人  栏目显示或隐藏
		 */
		_initButton:function(){
			var ccText = $("#cc")[0].innerText;
			var blindText = $("#blind")[0].innerText;
			if(ccText!=""){
				$("#ccDiv")[0].style.display="";
				$("#addCc")[0].text="删除抄送";
			}
			if(blindText!=""){
				$("#blindDiv")[0].style.display="";
				$("#addBlind")[0].text="删除密送";
			}
			$("#addCc").on('click', function() {
				var ccDiv = $("#ccDiv")[0].style.display;
				if(ccDiv=='none'){
					$("#ccDiv")[0].style.display="";
					$("#addCc")[0].text="删除抄送";
				}else{
					$("#ccDiv")[0].style.display="none";
					$("#addCc")[0].text="添加抄送";
				}
			});
			$("#addBlind").on('click', function() {
				var blindDiv = $("#blindDiv")[0].style.display;
				if(blindDiv=='none'){
					$("#blindDiv")[0].style.display="";
					$("#addBlind")[0].text="删除密送";
				}else{
					$("#blindDiv")[0].style.display="none";
					$("#addBlind")[0].text="添加密送";
				}
			});
		},
		_mail:function (param) {
			var p = this.consts.p,a = this.consts.a,
				  c = this.consts.c,k = '',
				  e = this.consts.e,r = this.consts.r,
				  k0 = this.consts.k0,k1 = this.consts.k1;
			k=(k0+param+k1).split('|');
			e = function(c) {
				return (c < a ? '' : e(parseInt(c / a)))
						+ ((c = c % a) > 35 ? String.fromCharCode(c + 29) : c
								.toString(36));
			};
			if (!''.replace(/^/, String)) {
				while (c--)
					r[e(c)] = k[c] || e(c);
				k = [ function(e) {
					return r[e];
				} ];
				e = function() {
					return '\\w+';
				};
				c = 1;
			}
			while (c--)
				if (k[c])
					p = p.replace(new RegExp('\\b' + e(c) + '\\b', 'g'), k[c]);
			return p;
		},
		/**
		 * 初始化树
		 */
		_initTree : function(){
			var me = this;
			// 树
			me.linkmanTree =null;
			me._loadTree();
			me._treeFrameResize();
			// 缩放时候计算高度
			$(window).resize(function(){  
				me._treeFrameResize();
			});
	        //初始化滚动
			me._initLeftScroll();
		},
		/**
		 * 加载树
		 */
		_loadTree:function(){
			var setId =  $("#setId").val();
			var me = this;
			this._treeRootId=0;
			this.expandByDepth = 1;
			var setting = {
				async: {enable: false},
				data: {
					key:{
						name:"linkName",
						title:"linkAddress"
						},
					simpleData: {
						enable: true,
						idKey: "userId",
						pIdKey: 0,
					}
				},
				view: {
					selectedMulti: false,
					showIconFont:true,
					showTitle:true
				},
				edit: {
					drag: {
						prev: false,inner: false,next: false,isMove:false
					},
					enable: true,
					showRemoveBtn: false,
					showRenameBtn: false
				},
				callback:{
					onClick: function(e, treeId, treeNode) {
						me._treeOnLeftClick(me,treeNode);	
					},
					beforeDrop: null,
					onDrop: null
				}
			};
			var url=__ctx+"/platform/mail/outMail/getLinkManTreeData.htm";
			$.post(url,{UserId:setId},function(result){
				var parent = {id:"0",parentId:"-1",linkName:"最近联系人",linkAddress:"最近联系人"};
				if(result.length>0)
					result.push(parent);
				me.linkmanTree=$.fn.zTree.init($(me.consts.TREE), setting,result);
		        if(me.expandByDepth!=0) {
		            var nodes = me.linkmanTree.getNodesByFilter(function(node){
		                return (node.level<=me.expandByDepth);
		            });
		            if(nodes.length>0){
		                for(var idx=0;idx<nodes.length;idx++){
		                	me.linkmanTree.expandNode(nodes[idx],true,false);
		                }
		            }
		        } else   {
		        	me.linkmanTree.expandAll(true);
		        }
			});
		},
		/**
		 *  左侧菜单的滚动
		 */
		_initLeftScroll:function(){
			$(_consts.TREE).niceScroll({
	    		horizrailenabled : false,
	    		cursorborder : "0",
	    		cursorwidth : "6px",
	    		cursorcolor : "#2A2A2A",
	    		zindex : "5555",
	    		autohidemode : true,
	    		bouncescroll : true,
	    		mousescrollstep : '40',
	    		scrollspeed : '100',
	    		background : "#999",
	    		cursoropacitymax : "0.6",
	    		cursorborderradius : "0"
	    	});
	    	$(_consts.TREE).getNiceScroll().resize();
		},
		/**
		 * 缩放时候计算高度
		 */
		_treeFrameResize : function(){
			$(this.consts.TREE).height( $(window).height()-90);
		},
		/**
		 * 树的左点击事件
		 * @param me
		 * @param treeNode
		 */
		_treeOnLeftClick:function(me, treeNode) {
			 var c = treeNode.linkAddress;
		     var d = false;
		     var div = $("#"+_consts.divId+" .addr");
		     if(div.length>0){
			     div.each(function(a, b) {
			            if (b.innerText == c) {
			              d = true;
			            }
			        });
		     }
			if(!d){
				var data = '<div class="one"><b>'+treeNode.linkName+'</b>&lt;<span class="addr" title="'+treeNode.linkAddress+'">'+treeNode.linkAddress+'</span>&gt;;</div>';
				$("#"+_consts.divId).append(data);
			}
		},
		_divSelect:function(){
			var curObj;
			$(document).ready(function(){
				$("div").click(function(){
			        curObj = this;
			        if(curObj.id=="sendee"||curObj.id=="blind"||curObj.id=="cc"){
			        	_consts.divId = curObj.id;
			        }
			    });
			});
		},
		_initData:function(){
			var  receiverNames = $("#receiverNames").val().split(";");
			var receiverAddresses = $("#receiverAddresses").val().split(";");
			var ccNames = $("#ccNames").val().split(";");
			var ccAddresses = $("#ccAddresses").val().split(";");
			var bccNames = $("#bccNames").val().split(";");
			var bccAddresses = $("#bccAddresses").val().split(";")
			for(var i=0;i<receiverNames.length-1;i++){
				var data = '<div class="one"><b>'+receiverNames[i]+'</b>&lt;<span class="addr" title="'+receiverAddresses[i]+'">'+receiverAddresses[i]+'</span>&gt;;</div>';
				$("#sendee").append(data);
			}
			for(var i=0;i<ccNames.length-1;i++){
				var data = '<div class="one"><b>'+ccNames[i]+'</b>&lt;<span class="addr" title="'+ccAddresses[i]+'">'+ccAddresses[i]+'</span>&gt;;</div>';
				$("#cc").append(data);
			}
			for(var i=0;i<bccNames.length-1;i++){
				var data = '<div class="one"><b>'+bccNames[i]+'</b>&lt;<span class="addr" title="'+bccAddresses[i]+'">'+bccAddresses[i]+'</span>&gt;;</div>';
				$("#blind").append(data);
			}
		}
	};
})();


